<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake - Game Arcade</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .game-canvas-wrapper {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }

        canvas {
            border-radius: 10px;
            background: #0a0a0a;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .info-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
        }

        .info-item { text-align: center; }
        .info-item .label { font-size: 0.8em; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .info-item .value { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }

        .d-pad {
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 6px;
            justify-content: center;
            margin: 15px auto;
            width: fit-content;
        }

        .d-pad button {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
        }

        .d-pad button:active { background: var(--primary-color); transform: scale(0.95); }

        .d-pad .up { grid-area: up; }
        .d-pad .down { grid-area: down; }
        .d-pad .left { grid-area: left; }
        .d-pad .right { grid-area: right; }

        .start-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            color: white;
            font-size: 1.5rem;
            gap: 10px;
        }

        .start-overlay .sub { font-size: 0.9rem; color: var(--text-secondary); }

        .canvas-container {
            position: relative;
            display: inline-block;
        }

        @media (max-width: 480px) {
            canvas { max-width: 100%; }
            .d-pad button { width: 50px; height: 50px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>Snake</h1>
            <a href="../index.html" class="back-btn">Home</a>
        </div>

        <div id="setup-screen">
            <div class="game-container" style="text-align: center;">
                <h2 style="margin-bottom: 20px;">Snake</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Eat food to grow longer. Don't hit the walls or yourself!</p>

                <div class="difficulty-selection" style="margin: 20px 0;">
                    <button class="difficulty-btn active" data-diff="easy" onclick="selectDifficulty('easy')">Easy</button>
                    <button class="difficulty-btn" data-diff="medium" onclick="selectDifficulty('medium')">Medium</button>
                    <button class="difficulty-btn" data-diff="hard" onclick="selectDifficulty('hard')">Hard</button>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button class="btn btn-success" onclick="startGame()">Start Game</button>
                </div>
            </div>
        </div>

        <div id="game-screen" style="display: none;">
            <div class="info-bar">
                <div class="info-item">
                    <div class="label">Score</div>
                    <div class="value" id="score">0</div>
                </div>
                <div class="info-item">
                    <div class="label">Length</div>
                    <div class="value" id="length">3</div>
                </div>
                <div class="info-item">
                    <div class="label">High Score</div>
                    <div class="value" id="hi-score">0</div>
                </div>
            </div>

            <div class="game-canvas-wrapper">
                <div class="canvas-container">
                    <canvas id="canvas" width="400" height="400"></canvas>
                    <div class="start-overlay" id="overlay">
                        <div>Press any key to start</div>
                        <div class="sub">Arrow keys or WASD to move</div>
                    </div>
                </div>
            </div>

            <div class="d-pad" id="dpad">
                <button class="up" onclick="setDir(0,-1)">&#9650;</button>
                <button class="left" onclick="setDir(-1,0)">&#9664;</button>
                <button class="right" onclick="setDir(1,0)">&#9654;</button>
                <button class="down" onclick="setDir(0,1)">&#9660;</button>
            </div>

            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="newGame()">New Game</button>
                <button class="btn btn-secondary" onclick="goToMenu()">Menu</button>
            </div>

            <div class="game-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">High Scores</h3>
                <div id="high-scores"></div>
            </div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script>
        const GAME_NAME = 'snake';
        const GRID = 20;
        const CELL_SIZE = 20;
        const CANVAS_SIZE = GRID * CELL_SIZE;

        const SPEEDS = { easy: 150, medium: 100, hard: 65 };

        let canvas, ctx;
        let state = {
            difficulty: 'easy',
            snake: [],
            food: null,
            dir: { x: 1, y: 0 },
            nextDir: { x: 1, y: 0 },
            score: 0,
            gameOver: false,
            started: false,
            interval: null
        };

        function selectDifficulty(diff) {
            state.difficulty = diff;
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.toggle('active', b.dataset.diff === diff));
        }

        function startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            canvas = document.getElementById('canvas');
            canvas.width = CANVAS_SIZE;
            canvas.height = CANVAS_SIZE;
            ctx = canvas.getContext('2d');
            newGame();
        }

        function goToMenu() {
            clearInterval(state.interval);
            document.getElementById('setup-screen').style.display = '';
            document.getElementById('game-screen').style.display = 'none';
        }

        function newGame() {
            clearInterval(state.interval);
            const mid = Math.floor(GRID / 2);
            state.snake = [
                { x: mid, y: mid },
                { x: mid - 1, y: mid },
                { x: mid - 2, y: mid }
            ];
            state.dir = { x: 1, y: 0 };
            state.nextDir = { x: 1, y: 0 };
            state.score = 0;
            state.gameOver = false;
            state.started = false;

            spawnFood();
            draw();
            updateInfo();

            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('overlay').innerHTML = '<div>Press any key to start</div><div class="sub">Arrow keys or WASD to move</div>';

            // Load high score
            const scores = GameUtils.highScores.get(GAME_NAME);
            document.getElementById('hi-score').textContent = scores.length > 0 ? scores[0].score : 0;

            GameUtils.renderHighScores(GAME_NAME, 'high-scores');
        }

        function spawnFood() {
            let pos;
            do {
                pos = { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
            } while (state.snake.some(s => s.x === pos.x && s.y === pos.y));
            state.food = pos;
        }

        function beginGame() {
            if (state.started) return;
            state.started = true;
            document.getElementById('overlay').style.display = 'none';
            state.interval = setInterval(tick, SPEEDS[state.difficulty]);
        }

        function setDir(x, y) {
            // Prevent reversing
            if (state.dir.x === -x && state.dir.y === -y) return;
            if (x === 0 && y === 0) return;
            state.nextDir = { x, y };
            if (!state.started && !state.gameOver) beginGame();
        }

        document.addEventListener('keydown', (e) => {
            const map = {
                'ArrowUp': [0, -1], 'ArrowDown': [0, 1], 'ArrowLeft': [-1, 0], 'ArrowRight': [1, 0],
                'w': [0, -1], 's': [0, 1], 'a': [-1, 0], 'd': [1, 0],
                'W': [0, -1], 'S': [0, 1], 'A': [-1, 0], 'D': [1, 0]
            };
            if (map[e.key]) {
                e.preventDefault();
                setDir(...map[e.key]);
            } else if (!state.started && !state.gameOver) {
                beginGame();
            }
        });

        function tick() {
            state.dir = state.nextDir;
            const head = state.snake[0];
            const newHead = { x: head.x + state.dir.x, y: head.y + state.dir.y };

            // Wall collision
            if (newHead.x < 0 || newHead.x >= GRID || newHead.y < 0 || newHead.y >= GRID) {
                gameOver();
                return;
            }

            // Self collision
            if (state.snake.some(s => s.x === newHead.x && s.y === newHead.y)) {
                gameOver();
                return;
            }

            state.snake.unshift(newHead);

            // Food check
            if (newHead.x === state.food.x && newHead.y === state.food.y) {
                state.score += 10;
                spawnFood();
            } else {
                state.snake.pop();
            }

            draw();
            updateInfo();
        }

        function gameOver() {
            state.gameOver = true;
            clearInterval(state.interval);

            const diffMult = { easy: 1, medium: 2, hard: 3 }[state.difficulty];
            const finalScore = state.score * diffMult;

            GameUtils.stats.update(GAME_NAME, 'win');
            GameUtils.highScores.add(GAME_NAME, GameUtils.playerName.get(1), finalScore, { difficulty: state.difficulty });

            // Flash death
            draw();
            const head = state.snake[0];
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(head.x * CELL_SIZE, head.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);

            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('overlay').innerHTML = `<div>Game Over!</div><div class="sub">Score: ${finalScore}</div><div class="sub" style="margin-top: 10px;">Tap or press any key for new game</div>`;

            const scores = GameUtils.highScores.get(GAME_NAME);
            document.getElementById('hi-score').textContent = scores.length > 0 ? scores[0].score : 0;
            GameUtils.renderHighScores(GAME_NAME, 'high-scores');

            // Restart on next input
            const restart = (e) => {
                document.removeEventListener('keydown', restart);
                document.getElementById('overlay').removeEventListener('click', restart);
                newGame();
            };
            setTimeout(() => {
                document.addEventListener('keydown', restart, { once: true });
                document.getElementById('overlay').addEventListener('click', restart, { once: true });
            }, 500);
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // Grid lines (subtle)
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= GRID; i++) {
                ctx.beginPath();
                ctx.moveTo(i * CELL_SIZE, 0);
                ctx.lineTo(i * CELL_SIZE, CANVAS_SIZE);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * CELL_SIZE);
                ctx.lineTo(CANVAS_SIZE, i * CELL_SIZE);
                ctx.stroke();
            }

            // Food
            if (state.food) {
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(
                    state.food.x * CELL_SIZE + CELL_SIZE / 2,
                    state.food.y * CELL_SIZE + CELL_SIZE / 2,
                    CELL_SIZE / 2 - 2, 0, Math.PI * 2
                );
                ctx.fill();
            }

            // Snake
            state.snake.forEach((seg, i) => {
                const t = i / state.snake.length;
                const g = Math.floor(200 - t * 150);
                ctx.fillStyle = i === 0 ? '#22c55e' : `rgb(${Math.floor(34 + t * 20)}, ${g}, ${Math.floor(62 + t * 20)})`;
                const padding = i === 0 ? 1 : 2;
                ctx.fillRect(
                    seg.x * CELL_SIZE + padding,
                    seg.y * CELL_SIZE + padding,
                    CELL_SIZE - padding * 2,
                    CELL_SIZE - padding * 2
                );

                // Eyes on head
                if (i === 0) {
                    ctx.fillStyle = 'white';
                    const eyeSize = 3;
                    const cx = seg.x * CELL_SIZE + CELL_SIZE / 2;
                    const cy = seg.y * CELL_SIZE + CELL_SIZE / 2;
                    if (state.dir.x !== 0) {
                        ctx.fillRect(cx + state.dir.x * 4 - 1, cy - 5, eyeSize, eyeSize);
                        ctx.fillRect(cx + state.dir.x * 4 - 1, cy + 3, eyeSize, eyeSize);
                    } else {
                        ctx.fillRect(cx - 5, cy + state.dir.y * 4 - 1, eyeSize, eyeSize);
                        ctx.fillRect(cx + 3, cy + state.dir.y * 4 - 1, eyeSize, eyeSize);
                    }
                }
            });
        }

        function updateInfo() {
            document.getElementById('score').textContent = state.score;
            document.getElementById('length').textContent = state.snake.length;
        }
    </script>
</body>
</html>
