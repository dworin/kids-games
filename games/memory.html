<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Snap - Game Arcade</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .memory-board {
            display: grid;
            gap: 10px;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: var(--dark-bg);
            border-radius: 15px;
        }
        .memory-board.size-4x3 { grid-template-columns: repeat(4, 1fr); }
        .memory-board.size-4x4 { grid-template-columns: repeat(4, 1fr); }
        .memory-board.size-6x4 { grid-template-columns: repeat(6, 1fr); }
        .memory-board.size-6x6 { grid-template-columns: repeat(6, 1fr); }

        .memory-tile {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            transition: transform 0.3s, background 0.3s;
            position: relative;
            user-select: none;
        }
        .memory-tile:hover:not(.flipped):not(.matched) {
            transform: scale(1.05);
        }
        .memory-tile.flipped {
            background: white;
            transform: rotateY(180deg);
        }
        .memory-tile.matched {
            background: var(--success-color);
            cursor: default;
        }
        .memory-tile .symbol {
            display: none;
        }
        .memory-tile.flipped .symbol,
        .memory-tile.matched .symbol {
            display: block;
            transform: rotateY(180deg);
        }
        .player-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .player-box {
            padding: 15px 30px;
            border-radius: 10px;
            background: var(--card-bg);
            text-align: center;
            transition: all 0.3s;
        }
        .player-box.active {
            background: var(--primary-color);
            transform: scale(1.05);
        }
        .player-box .name {
            font-weight: 700;
            margin-bottom: 5px;
        }
        .player-box .pairs {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .moves-display {
            text-align: center;
            color: var(--text-secondary);
            margin: 10px 0;
        }
        .size-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .size-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
        }
        .size-btn:hover { border-color: var(--primary-color); }
        .size-btn.active { background: var(--primary-color); border-color: var(--primary-color); }

        @media (max-width: 500px) {
            .memory-tile { font-size: 1.5rem; }
            .memory-board { gap: 5px; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>Memory Snap</h1>
            <a href="../index.html" class="back-btn">&#8592; Back to Games</a>
        </div>

        <div id="setup" class="game-container">
            <h2 style="text-align: center; margin-bottom: 20px;">Select Game Mode</h2>

            <div class="mode-selection">
                <button class="mode-btn active" data-mode="single">Single Player</button>
                <button class="mode-btn" data-mode="pvp">2 Players</button>
            </div>

            <h3 style="text-align: center; margin: 20px 0 15px;">Board Size</h3>
            <div class="size-selection">
                <button class="size-btn" data-size="4x3">4x3 (Easy)</button>
                <button class="size-btn active" data-size="4x4">4x4 (Medium)</button>
                <button class="size-btn" data-size="6x4">6x4 (Hard)</button>
                <button class="size-btn" data-size="6x6">6x6 (Expert)</button>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="startGame()">Start Game</button>
            </div>
        </div>

        <div id="game" class="game-container" style="display: none;">
            <div id="playerIndicator" class="player-indicator"></div>

            <div class="moves-display" id="movesDisplay">Moves: 0</div>

            <div class="memory-board" id="board"></div>

            <div class="game-status" id="status"></div>

            <div class="btn-group">
                <button class="btn" onclick="resetGame()">New Game</button>
                <button class="btn btn-secondary" onclick="backToSetup()">Change Settings</button>
            </div>
        </div>

        <div class="game-container">
            <h3 style="margin-bottom: 15px;">Statistics</h3>
            <div id="stats"></div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script>
        // Emoji symbols for matching
        const symbols = [
            'ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼',
            'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ”',
            'ðŸ¦„', 'ðŸ'
        ];

        // Game state
        let tiles = [];
        let flippedTiles = [];
        let matchedPairs = 0;
        let totalPairs = 0;
        let moves = 0;
        let gameActive = false;
        let gameMode = 'single';
        let boardSize = '4x4';
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let player1Name, player2Name;
        let isProcessing = false;

        function init() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameMode = btn.dataset.mode;
                });
            });

            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    boardSize = btn.dataset.size;
                });
            });

            GameUtils.renderStats('memory', 'stats');
        }

        function getBoardDimensions() {
            const sizes = {
                '4x3': { cols: 4, rows: 3 },
                '4x4': { cols: 4, rows: 4 },
                '6x4': { cols: 6, rows: 4 },
                '6x6': { cols: 6, rows: 6 }
            };
            return sizes[boardSize];
        }

        function startGame() {
            player1Name = GameUtils.playerName.get(1);
            player2Name = GameUtils.playerName.get(2);

            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';

            resetGame();
        }

        function backToSetup() {
            document.getElementById('setup').style.display = 'block';
            document.getElementById('game').style.display = 'none';
        }

        function resetGame() {
            const { cols, rows } = getBoardDimensions();
            totalPairs = (cols * rows) / 2;

            // Create pairs of symbols
            const gameSymbols = symbols.slice(0, totalPairs);
            const pairs = [...gameSymbols, ...gameSymbols];
            tiles = GameUtils.shuffleArray(pairs).map((symbol, index) => ({
                id: index,
                symbol: symbol,
                flipped: false,
                matched: false
            }));

            flippedTiles = [];
            matchedPairs = 0;
            moves = 0;
            currentPlayer = 1;
            scores = { 1: 0, 2: 0 };
            gameActive = true;
            isProcessing = false;

            renderBoard();
            renderPlayerIndicator();
            updateDisplay();
        }

        function renderBoard() {
            const board = document.getElementById('board');
            const { cols } = getBoardDimensions();

            board.className = `memory-board size-${boardSize}`;
            board.innerHTML = '';

            tiles.forEach((tile, index) => {
                const tileEl = document.createElement('div');
                tileEl.className = 'memory-tile';
                if (tile.flipped) tileEl.classList.add('flipped');
                if (tile.matched) tileEl.classList.add('matched');

                tileEl.innerHTML = `<span class="symbol">${tile.symbol}</span>`;
                tileEl.addEventListener('click', () => flipTile(index));
                board.appendChild(tileEl);
            });
        }

        function renderPlayerIndicator() {
            const container = document.getElementById('playerIndicator');

            if (gameMode === 'single') {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="player-box ${currentPlayer === 1 ? 'active' : ''}" id="p1Box">
                    <div class="name">${player1Name}</div>
                    <div class="pairs">${scores[1]} pairs</div>
                </div>
                <div class="player-box ${currentPlayer === 2 ? 'active' : ''}" id="p2Box">
                    <div class="name">${player2Name}</div>
                    <div class="pairs">${scores[2]} pairs</div>
                </div>
            `;
        }

        function updateDisplay() {
            document.getElementById('movesDisplay').textContent = `Moves: ${moves}`;

            if (gameMode === 'pvp') {
                document.getElementById('p1Box').className = `player-box ${currentPlayer === 1 ? 'active' : ''}`;
                document.getElementById('p2Box').className = `player-box ${currentPlayer === 2 ? 'active' : ''}`;
                document.getElementById('p1Box').querySelector('.pairs').textContent = `${scores[1]} pairs`;
                document.getElementById('p2Box').querySelector('.pairs').textContent = `${scores[2]} pairs`;
            }
        }

        async function flipTile(index) {
            if (!gameActive || isProcessing) return;
            if (tiles[index].flipped || tiles[index].matched) return;
            if (flippedTiles.length >= 2) return;

            tiles[index].flipped = true;
            flippedTiles.push(index);
            renderBoard();

            if (flippedTiles.length === 2) {
                moves++;
                updateDisplay();
                isProcessing = true;

                await GameUtils.delay(800);

                const [first, second] = flippedTiles;
                if (tiles[first].symbol === tiles[second].symbol) {
                    // Match found!
                    tiles[first].matched = true;
                    tiles[second].matched = true;
                    matchedPairs++;
                    scores[currentPlayer]++;

                    updateDisplay();

                    if (matchedPairs === totalPairs) {
                        endGame();
                    }
                    // In 2-player mode, same player goes again on match
                } else {
                    // No match
                    tiles[first].flipped = false;
                    tiles[second].flipped = false;

                    // Switch players in 2-player mode
                    if (gameMode === 'pvp') {
                        currentPlayer = currentPlayer === 1 ? 2 : 1;
                        updateDisplay();
                    }
                }

                flippedTiles = [];
                isProcessing = false;
                renderBoard();
            }
        }

        function endGame() {
            gameActive = false;
            const statusEl = document.getElementById('status');

            if (gameMode === 'single') {
                statusEl.textContent = `Congratulations! You found all pairs in ${moves} moves!`;
                statusEl.classList.add('winner');

                GameUtils.stats.update('memory', 'win');

                // Score: lower moves = higher score
                const maxMoves = totalPairs * 3;
                const score = Math.max(0, maxMoves - moves) * 10 + totalPairs * 5;
                GameUtils.highScores.add('memory', player1Name, score, { moves, pairs: totalPairs });
            } else {
                if (scores[1] > scores[2]) {
                    statusEl.textContent = `${player1Name} wins with ${scores[1]} pairs!`;
                    GameUtils.stats.update('memory', 'win');
                } else if (scores[2] > scores[1]) {
                    statusEl.textContent = `${player2Name} wins with ${scores[2]} pairs!`;
                    GameUtils.stats.update('memory', 'loss');
                } else {
                    statusEl.textContent = `It's a tie! Both players got ${scores[1]} pairs!`;
                    GameUtils.stats.update('memory', 'draw');
                }
                statusEl.classList.add('winner');
            }

            GameUtils.renderStats('memory', 'stats');
        }

        init();
    </script>
</body>
</html>
