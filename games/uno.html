<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uno - Game Arcade</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .play-area {
            text-align: center;
            margin: 15px 0;
        }

        .pile-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
        }

        .uno-card {
            width: 80px;
            height: 120px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            position: relative;
            user-select: none;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .uno-card:hover:not(.disabled) {
            transform: translateY(-10px);
        }

        .uno-card.disabled { cursor: default; opacity: 0.6; }

        .uno-card.red { background: #dc2626; color: white; }
        .uno-card.blue { background: #2563eb; color: white; }
        .uno-card.green { background: #16a34a; color: white; }
        .uno-card.yellow { background: #eab308; color: #1e293b; }
        .uno-card.wild { background: linear-gradient(135deg, #dc2626 25%, #2563eb 25%, #2563eb 50%, #16a34a 50%, #16a34a 75%, #eab308 75%); color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        .uno-card .card-value {
            font-size: 1.8rem;
            line-height: 1;
        }

        .uno-card .card-label {
            font-size: 0.6rem;
            position: absolute;
            bottom: 6px;
            letter-spacing: 0.5px;
        }

        .draw-pile {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .hand {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            padding: 15px;
            min-height: 140px;
            background: var(--dark-bg);
            border-radius: 12px;
        }

        .hand .uno-card {
            width: 65px;
            height: 100px;
            font-size: 1.4rem;
        }

        .hand .uno-card .card-label { font-size: 0.5rem; bottom: 4px; }

        .opponent-hand {
            display: flex;
            gap: 4px;
            justify-content: center;
            padding: 10px;
        }

        .opponent-card {
            width: 40px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .color-chooser {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 15px 0;
        }

        .color-choice {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .color-choice:hover { transform: scale(1.2); }
        .color-choice.c-red { background: #dc2626; }
        .color-choice.c-blue { background: #2563eb; }
        .color-choice.c-green { background: #16a34a; }
        .color-choice.c-yellow { background: #eab308; }

        .uno-btn {
            padding: 12px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            animation: unoPulse 1s ease-in-out infinite;
            display: none;
        }

        .uno-btn.visible { display: inline-block; }

        @keyframes unoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .direction-indicator {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin: 5px 0;
        }

        @media (max-width: 480px) {
            .uno-card { width: 65px; height: 100px; font-size: 1.4rem; }
            .hand .uno-card { width: 50px; height: 78px; font-size: 1.1rem; }
            .hand .uno-card .card-label { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>Uno</h1>
            <a href="../index.html" class="back-btn">Home</a>
        </div>

        <div id="setup-screen">
            <div class="game-container" style="text-align: center;">
                <h2 style="margin-bottom: 20px;">Uno</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Match cards by color or number. Be the first to empty your hand!</p>

                <div class="difficulty-selection" style="margin: 20px 0;">
                    <button class="difficulty-btn active" data-diff="easy" onclick="selectDifficulty('easy')">Easy</button>
                    <button class="difficulty-btn" data-diff="medium" onclick="selectDifficulty('medium')">Medium</button>
                    <button class="difficulty-btn" data-diff="hard" onclick="selectDifficulty('hard')">Hard</button>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button class="btn btn-success" onclick="startGame()">Start Game</button>
                </div>
            </div>
        </div>

        <div id="game-screen" style="display: none;">
            <div class="game-status" id="status">Your turn</div>

            <div class="game-container">
                <div style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">
                    Computer (<span id="ai-count">7</span> cards)
                </div>
                <div class="opponent-hand" id="ai-hand"></div>

                <div class="direction-indicator" id="direction">&#8635;</div>

                <div class="pile-area">
                    <div class="uno-card draw-pile" onclick="drawCard()">
                        DRAW<br><span id="deck-count">0</span>
                    </div>
                    <div class="uno-card" id="discard-top"></div>
                </div>

                <div id="color-chooser" class="color-chooser" style="display: none;">
                    <div class="color-choice c-red" onclick="chooseColor('red')"></div>
                    <div class="color-choice c-blue" onclick="chooseColor('blue')"></div>
                    <div class="color-choice c-green" onclick="chooseColor('green')"></div>
                    <div class="color-choice c-yellow" onclick="chooseColor('yellow')"></div>
                </div>

                <button class="uno-btn" id="uno-btn" onclick="callUno()">UNO!</button>

                <div style="text-align: center; color: var(--text-secondary); margin: 10px 0 5px;">
                    Your Hand
                </div>
                <div class="hand" id="player-hand"></div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="newGame()">New Game</button>
                <button class="btn btn-secondary" onclick="goToMenu()">Menu</button>
            </div>

            <div class="game-container" style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">High Scores</h3>
                <div id="high-scores"></div>
            </div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script>
        const GAME_NAME = 'uno';
        const COLORS = ['red', 'blue', 'green', 'yellow'];
        const VALUES = ['0','1','2','3','4','5','6','7','8','9','Skip','Reverse','Draw2'];
        const DISPLAY = { 'Skip': '⊘', 'Reverse': '⇄', 'Draw2': '+2', 'Wild': '★', 'WildDraw4': '+4' };

        let state = {
            difficulty: 'easy',
            deck: [],
            playerHand: [],
            aiHand: [],
            discardPile: [],
            currentColor: '',
            direction: 1,
            playerTurn: true,
            gameOver: false,
            choosingColor: false,
            pendingCard: null,
            calledUno: false
        };

        function selectDifficulty(diff) {
            state.difficulty = diff;
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.toggle('active', b.dataset.diff === diff));
        }

        function startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            newGame();
        }

        function goToMenu() {
            document.getElementById('setup-screen').style.display = '';
            document.getElementById('game-screen').style.display = 'none';
        }

        function createDeck() {
            const deck = [];
            for (const color of COLORS) {
                deck.push({ color, value: '0' });
                for (let i = 0; i < 2; i++) {
                    for (const v of VALUES.slice(1)) {
                        deck.push({ color, value: v });
                    }
                }
            }
            // Wild cards
            for (let i = 0; i < 4; i++) {
                deck.push({ color: 'wild', value: 'Wild' });
                deck.push({ color: 'wild', value: 'WildDraw4' });
            }
            return GameUtils.shuffleArray(deck);
        }

        function newGame() {
            state.deck = createDeck();
            state.playerHand = [];
            state.aiHand = [];
            state.discardPile = [];
            state.direction = 1;
            state.playerTurn = true;
            state.gameOver = false;
            state.choosingColor = false;
            state.calledUno = false;

            // Deal 7 cards each
            for (let i = 0; i < 7; i++) {
                state.playerHand.push(state.deck.pop());
                state.aiHand.push(state.deck.pop());
            }

            // Flip first card (ensure it's a number card)
            let first;
            do {
                first = state.deck.pop();
                if (['Wild', 'WildDraw4', 'Skip', 'Reverse', 'Draw2'].includes(first.value)) {
                    state.deck.unshift(first);
                    state.deck = GameUtils.shuffleArray(state.deck);
                    first = null;
                }
            } while (!first);

            state.discardPile.push(first);
            state.currentColor = first.color;

            document.getElementById('color-chooser').style.display = 'none';
            render();
            GameUtils.renderHighScores(GAME_NAME, 'high-scores');
        }

        function getTopCard() {
            return state.discardPile[state.discardPile.length - 1];
        }

        function canPlay(card) {
            const top = getTopCard();
            if (card.color === 'wild') return true;
            if (card.color === state.currentColor) return true;
            if (card.value === top.value) return true;
            return false;
        }

        function playCard(index) {
            if (!state.playerTurn || state.gameOver || state.choosingColor) return;

            const card = state.playerHand[index];
            if (!canPlay(card)) return;

            state.playerHand.splice(index, 1);
            state.discardPile.push(card);

            if (card.color === 'wild') {
                state.choosingColor = true;
                state.pendingCard = card;
                document.getElementById('color-chooser').style.display = '';
                render();
                return;
            }

            state.currentColor = card.color;
            afterPlay(card, false);
        }

        function chooseColor(color) {
            if (!state.choosingColor) return;
            state.choosingColor = false;
            state.currentColor = color;
            document.getElementById('color-chooser').style.display = 'none';
            afterPlay(state.pendingCard, false);
        }

        function afterPlay(card, isAI) {
            const opponent = isAI ? state.playerHand : state.aiHand;

            // Handle special cards
            if (card.value === 'Skip') {
                // Skip opponent's turn
            } else if (card.value === 'Reverse') {
                state.direction *= -1;
            } else if (card.value === 'Draw2') {
                for (let i = 0; i < 2; i++) {
                    const drawn = drawFromDeck();
                    if (drawn) opponent.push(drawn);
                }
            } else if (card.value === 'WildDraw4') {
                for (let i = 0; i < 4; i++) {
                    const drawn = drawFromDeck();
                    if (drawn) opponent.push(drawn);
                }
            } else {
                // Normal card - switch turns
                state.playerTurn = !state.playerTurn;
                render();
                if (!state.playerTurn) setTimeout(aiTurn, 800);
                checkWin();
                return;
            }

            // Skip/Reverse/Draw: turn stays with current player for 2-player
            // In 2-player UNO, Reverse acts like Skip
            if (card.value !== 'Reverse' || true) {
                // After special card, keep same player's opponent skipped
                // Actually in 2-player: skip, reverse, draw2, wd4 all skip opponent
                state.playerTurn = isAI ? false : true;
                // Wait, we want to skip the opponent. If player played it, player goes again (opponent skipped)
                // Actually let's just do: skip means opponent doesn't go
                state.playerTurn = !isAI;
            }

            render();
            checkWin();
            if (!state.playerTurn && !state.gameOver) setTimeout(aiTurn, 800);
        }

        function drawFromDeck() {
            if (state.deck.length === 0) {
                // Reshuffle discard pile
                if (state.discardPile.length <= 1) return null;
                const top = state.discardPile.pop();
                state.deck = GameUtils.shuffleArray(state.discardPile);
                state.discardPile = [top];
            }
            return state.deck.pop();
        }

        function drawCard() {
            if (!state.playerTurn || state.gameOver || state.choosingColor) return;

            const card = drawFromDeck();
            if (!card) return;
            state.playerHand.push(card);

            // After drawing, if the card can be played, player can choose to play or keep
            state.playerTurn = false;
            render();

            // Give turn to AI
            setTimeout(aiTurn, 800);
        }

        function callUno() {
            state.calledUno = true;
            document.getElementById('uno-btn').classList.remove('visible');
        }

        function checkWin() {
            if (state.playerHand.length === 0) {
                state.gameOver = true;
                const score = state.aiHand.reduce((sum, c) => sum + cardPoints(c), 0);
                const diffMult = { easy: 1, medium: 2, hard: 3 }[state.difficulty];
                GameUtils.stats.update(GAME_NAME, 'win');
                GameUtils.highScores.add(GAME_NAME, GameUtils.playerName.get(1), score * diffMult);
                updateStatus('You win!', true);
                GameUtils.renderHighScores(GAME_NAME, 'high-scores');
            } else if (state.aiHand.length === 0) {
                state.gameOver = true;
                GameUtils.stats.update(GAME_NAME, 'loss');
                updateStatus('Computer wins!', false);
                GameUtils.renderHighScores(GAME_NAME, 'high-scores');
            }

            // UNO check
            if (state.playerHand.length === 1) {
                document.getElementById('uno-btn').classList.add('visible');
            } else {
                document.getElementById('uno-btn').classList.remove('visible');
                state.calledUno = false;
            }
        }

        function cardPoints(card) {
            if (card.value === 'Wild' || card.value === 'WildDraw4') return 50;
            if (['Skip', 'Reverse', 'Draw2'].includes(card.value)) return 20;
            return parseInt(card.value) || 0;
        }

        // AI
        function aiTurn() {
            if (state.playerTurn || state.gameOver) return;

            const playable = state.aiHand
                .map((card, i) => ({ card, i }))
                .filter(({ card }) => canPlay(card));

            if (playable.length === 0) {
                // Draw
                const card = drawFromDeck();
                if (card) {
                    state.aiHand.push(card);
                    // Check if drawn card is playable
                    if (canPlay(card)) {
                        if (state.difficulty !== 'easy' || Math.random() > 0.5) {
                            setTimeout(() => aiPlayCard(state.aiHand.length - 1), 500);
                            return;
                        }
                    }
                }
                state.playerTurn = true;
                render();
                return;
            }

            let choice;
            if (state.difficulty === 'easy') {
                choice = playable[Math.floor(Math.random() * playable.length)];
            } else {
                choice = aiBestChoice(playable);
            }

            aiPlayCard(choice.i);
        }

        function aiBestChoice(playable) {
            // Prefer: action cards > match color > wilds last
            const scored = playable.map(p => {
                let score = 0;
                const c = p.card;
                if (c.value === 'Draw2' || c.value === 'WildDraw4') score += 10;
                if (c.value === 'Skip' || c.value === 'Reverse') score += 5;
                if (c.color === state.currentColor) score += 3;
                if (c.color === 'wild') score -= 2; // Save wilds
                score += parseInt(c.value) || 0; // Play high numbers first

                if (state.difficulty === 'hard') {
                    // Try to keep colors diverse
                    const colorCounts = {};
                    state.aiHand.forEach(h => { if (h.color !== 'wild') colorCounts[h.color] = (colorCounts[h.color] || 0) + 1; });
                    if (colorCounts[c.color] > 2) score += 2;
                }

                return { ...p, score };
            });

            scored.sort((a, b) => b.score - a.score);
            return scored[0];
        }

        function aiPlayCard(index) {
            if (state.gameOver) return;

            const card = state.aiHand[index];
            state.aiHand.splice(index, 1);
            state.discardPile.push(card);

            if (card.color === 'wild') {
                // AI chooses most common color in hand
                const counts = {};
                state.aiHand.forEach(c => {
                    if (c.color !== 'wild') counts[c.color] = (counts[c.color] || 0) + 1;
                });
                let bestColor = 'red';
                let bestCount = 0;
                for (const [color, count] of Object.entries(counts)) {
                    if (count > bestCount) { bestCount = count; bestColor = color; }
                }
                state.currentColor = bestColor;
            } else {
                state.currentColor = card.color;
            }

            afterPlay(card, true);
        }

        function updateStatus(text, isWin) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = 'game-status' + (isWin ? ' winner' : '');
        }

        function render() {
            // Discard top
            const top = getTopCard();
            const discardEl = document.getElementById('discard-top');
            discardEl.className = 'uno-card ' + (top.color === 'wild' ? state.currentColor : top.color);
            const displayVal = DISPLAY[top.value] || top.value;
            discardEl.innerHTML = `<span class="card-value">${displayVal}</span>`;

            // Deck count
            document.getElementById('deck-count').textContent = state.deck.length;

            // AI hand
            const aiHandEl = document.getElementById('ai-hand');
            aiHandEl.innerHTML = '';
            state.aiHand.forEach(() => {
                const card = document.createElement('div');
                card.className = 'opponent-card';
                aiHandEl.appendChild(card);
            });
            document.getElementById('ai-count').textContent = state.aiHand.length;

            // Player hand
            const handEl = document.getElementById('player-hand');
            handEl.innerHTML = '';
            state.playerHand.forEach((card, i) => {
                const el = document.createElement('div');
                const playable = state.playerTurn && canPlay(card) && !state.choosingColor;
                el.className = 'uno-card ' + (card.color === 'wild' ? 'wild' : card.color) + (!playable ? ' disabled' : '');
                const displayVal = DISPLAY[card.value] || card.value;
                el.innerHTML = `<span class="card-value">${displayVal}</span>`;
                if (card.value.length > 1) {
                    el.innerHTML += `<span class="card-label">${card.value}</span>`;
                }
                el.addEventListener('click', () => playCard(i));
                handEl.appendChild(el);
            });

            // Direction
            document.getElementById('direction').textContent = state.direction === 1 ? '\u21bb' : '\u21ba';

            // Status
            if (!state.gameOver) {
                updateStatus(state.playerTurn ? 'Your turn - play a card or draw' : "Computer's turn...", false);
            }
        }
    </script>
</body>
</html>
